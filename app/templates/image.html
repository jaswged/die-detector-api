<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <title>Die Detector API</title>
</head>

<body>
    <h1 class="center">Die Detector Api</h1>
    <h3 class="center">Upload image to classify</h3>
    <form id="uploadForm" action="/uploader" method="POST" enctype="multipart/form-data">
        <div class="center">
            <input id='file-input' class='no-display' type="file" name="file" accept='image/*'
                onchange='showPicked(this)' />
            <button class='choose-file-button' type='button' onclick='showPicker()'>Select Image</button>
            <div class='upload-label'>
                <label id='upload-label'>No file chosen</label>
            </div>
            <div>
                <img id='image-picked' class='no-display' alt='Chosen Image' height='200'>
            </div>
            <button id='submit-button' class='analyze-button'>Submit</button>
            <button id='analyze-button' class='analyze-button' type='button' onclick="analyze()">Analyze</button>
            <button id='ajax-button' class='analyze-button' type='button' onclick="ajax_analyze()">Ajax Button</button>
        </div>
    </form>
    <script>
        // From FastAi
        const el = x => document.getElementById(x);

        function showPicker() { el('file-input').click(); }

        function showPicked(input) {
            el('upload-label').innerHTML = input.files[0].name;
            let reader = new FileReader();
            reader.onload = function (e) {
                el('image-picked').src = e.target.result;
                el('image-picked').className = '';
            };
            reader.readAsDataURL(input.files[0]);
        }

        function analyze() {
            console.log("Analyze!");
            const uploadFiles = el('file-input').files;
            if (uploadFiles.length != 1) alert('Please select 1 file to analyze!');

            el('analyze-button').innerHTML = 'Analyzing...';
            let xhr = new XMLHttpRequest();
            var loc = window.location;
            //xhr.setRequestHeader("Content-Type", "multipart/form-data");

            xhr.open('POST', `${loc.protocol}//${loc.hostname}:${loc.port}/uploader`, true);

            xhr.onreadystatechange = function() { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                    // Request finished. Do processing here.
                    console.log("request finished");

                    console.log("Response text below");
                    console.log(xhr.responseType);
                    console.log(xhr.responseText);
                    console.log(xhr.response);
                    console.log(xhr.responseXML);
                }
            }

            xhr.onerror = function () { alert(xhr.responseText); }
            xhr.onload = function (e) {
                if (this.readyState === 4) {
                    console.log("Ready state is 4");
                    var response = JSON.parse(e.target.responseText);
                    el('result-label').innerHTML = `Result = ${response['result']}`;
                }
                el('analyze-button').innerHTML = 'Analyze';
            };

            console.log("New form data");
            let fileData = new FormData();
            fileData.append('file', uploadFiles[0]);
            xhr.send(fileData);
        }

        function ajax_analyze() {
            $("#ajax-button").innerHTML = 'Ajax Analyzing...';
            //const form = $("#uploadForm");

            var form = $('#uploadForm')[0];
            var data = new FormData(form);

            $.ajax({
                type: "POST",
                enctype: 'multipart/form-data',
                url: "/uploader",
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 600000,
                success:function(data){
                    alert("worked");
                    console.log(data);
                },
                error: function(data){
                    alert("Error");
                    console.log(data);
                }
            });

            // $.ajax({
            //     url:'/uploader',
            //     type:'post',
            //     data:$('#myForm').serialize(),
            //     success:function(data){
            //         alert("worked");
            //         console.log(data);
            //     },
            //     error: function(data){
            //         alert("Error");
            //         console.log(data);
            //     }
            // });

            // $.ajax({
            //     type: "POST",
            //     url: '/uploader',
            //     data: form.serialize(), // serializes the form's elements.
            //     success: function(data) {
            //         console.log(data);
            //         alert(data); // show response from the py script.
            //     },
            //     error: function(data){
            //       console.log("Error calling endpoint");
            //       console.log(data);
            //     }
            // });
        }
    </script>
    <style>
        body {
            background-color: #fff;
        }

        .no-display {
            display: none;
        }

        .center {
            margin: auto;
            padding: 10px;
            padding-left: 50px;
            padding-right: 50px;
            text-align: center;
        }

        .analyze {
            margin-top: 5em;
        }

        .upload-label {
            padding: 10px;
            font-size: 12px;
        }

        .result-label {
            margin-top: 0.5em;
            padding: 10px;
            font-size: 13px;
        }

        button.choose-file-button {
            width: 200px;
            height: 40px;
            border-radius: 2px;
            background-color: #ffffff;
            border: solid 1px #f40e38;
            font-size: 13px;
            color: #e82e50;
        }

        button.analyze-button {
            width: 200px;
            height: 40px;
            border: solid 1px #f40e38;
            border-radius: 2px;
            background-color: #f40e38;
            font-size: 13px;
            color: #ffffff;
        }

        button:focus {
            outline: 0;
        }
    </style>
</body>

</html>